package com.teamoptimal.cse110project.data;

import android.util.Log;

import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBAttribute;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBAutoGeneratedKey;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBHashKey;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBIgnore;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBMapper;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBScanExpression;
import com.amazonaws.mobileconnectors.dynamodbv2.dynamodbmapper.DynamoDBTable;
import com.amazonaws.services.dynamodbv2.AmazonDynamoDBClient;
import com.amazonaws.services.dynamodbv2.model.AttributeValue;
import com.amazonaws.services.dynamodbv2.model.ComparisonOperator;
import com.amazonaws.services.dynamodbv2.model.Condition;
import com.amazonaws.services.dynamodbv2.model.ScanRequest;
import com.amazonaws.services.dynamodbv2.model.ScanResult;
import com.teamoptimal.cse110project.CreateRestroomActivity;
import com.teamoptimal.cse110project.MainActivity;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@DynamoDBTable(tableName = "Y4R_Restrooms")
public class Restroom {
    private String id;

    private Double longitude;
    private Double latitude;

    private static int currID;

    private String userEmail;
    private String description;
    private String tags;
    private String floor;
    private Double rating;
    private Integer ratingsCount;

    public Restroom () {
        id = "";
        userEmail = "";
        longitude = 0.0d;
        latitude = 0.0d;
        description = "";
        tags = "0000000000000000000000000000000";
        floor = "1";
        rating = 0.00;
        ratingsCount = 0;
    }

    @DynamoDBAttribute (attributeName = "User")
    public String getUser() { return userEmail; }
    public void setUser(String userEmail) { this.userEmail = userEmail; }

    @DynamoDBAttribute (attributeName = "Latitude")
    public double getLatitude() { return latitude;}
    public void setLatitude(Double latitude){ this.latitude = latitude; }

    @DynamoDBAttribute(attributeName = "Longitude")
    public double getLongitude() { return longitude;}
    public void setLongitude(Double longitude) { this.longitude = longitude;}

    @DynamoDBHashKey (attributeName = "ID")
    @DynamoDBAutoGeneratedKey
    public String getID() { return id; }
    public void setID(String id) { this.id = id; }

    @DynamoDBAttribute (attributeName = "Description")
    public String getDescription() { return description; }
    public void setDescription(String description) { this.description = description; }

    @DynamoDBAttribute (attributeName = "Tags")
    public String getTags() { return tags; }
    public void setTags(String tags) { this.tags = tags; }

    @DynamoDBAttribute (attributeName = "Floor")
    public String getFloor() { return floor; }
    public void setFloor(String floor) { this.floor = floor; }

    @DynamoDBAttribute(attributeName = "Rating")
    public Double getRating() { return rating; }
    public void setRating(Double rating) { this.rating = rating; }

    @DynamoDBAttribute(attributeName = "NumberOfRatings")
    public Integer getRatingsCount() { return ratingsCount; }
    public void setRatingsCount(int ratingsCount) { this.ratingsCount = ratingsCount; }

    @DynamoDBIgnore
    public void setTag(int index, boolean choice) {
        char[] chars = tags.toCharArray();
        if(choice) { chars[index] = '1'; }
        else { chars[index] = '0'; }
        tags = chars.toString();
    }

    @DynamoDBIgnore
    public double[] getLocation() {
        double[] location = new double[2];
        location[0] = longitude;
        location[1] = latitude;
        return location;
    }

    @DynamoDBIgnore
    public void setLocation(double longitude, double latitude) {
        this.longitude = longitude;
        this.latitude = latitude;
    }

    @DynamoDBIgnore
    public void updateRating(double review) {
        double sum = review + (rating * ratingsCount);
        double val = sum / (++ratingsCount);
        setRating(val);
    }

    @DynamoDBIgnore
    public boolean isInitialized() {
        if(longitude != 0.0d && latitude != 0.0d && !userEmail.equals("") && !description.equals(""))
            return true;
        return false;
    }

    public void create() {
        AmazonDynamoDBClient ddb = CreateRestroomActivity.clientManager.ddb();
        DynamoDBMapper mapper = new DynamoDBMapper(ddb);

        mapper.save(this);
    }

    public static List<Restroom> getRestrooms(double longitude, double latitude, int radius) {
        AmazonDynamoDBClient ddb = MainActivity.clientManager.ddb();
        DynamoDBMapper mapper = new DynamoDBMapper(ddb);

        Condition minLatitude = new Condition()
                .withComparisonOperator(ComparisonOperator.GE)
                .withAttributeValueList(new AttributeValue().withN("" + (latitude - (radius / 2))));
        Condition maxLatitude = new Condition()
                .withComparisonOperator(ComparisonOperator.LE)
                .withAttributeValueList(new AttributeValue().withN("" + (latitude + (radius / 2))));
        Condition minLongitude = new Condition()
                .withComparisonOperator(ComparisonOperator.GE)
                .withAttributeValueList(new AttributeValue().withN("" + (longitude - (radius / 2))));
        Condition maxLongitude = new Condition()
                .withComparisonOperator(ComparisonOperator.LE)
                .withAttributeValueList(new AttributeValue().withN("" + (longitude + (radius / 2))));

        Map<String, Condition> conditions = new HashMap<String, Condition>();
        conditions.put("Latitude", minLatitude);
        conditions.put("Latitude", maxLatitude);
        conditions.put("Longitude", minLongitude);
        conditions.put("Longitude", maxLongitude);

        DynamoDBScanExpression scanExpression = new DynamoDBScanExpression();
        scanExpression.setScanFilter(conditions);

        List<Restroom> scanResult = mapper.scan(Restroom.class, scanExpression);
        return scanResult;
    }
}